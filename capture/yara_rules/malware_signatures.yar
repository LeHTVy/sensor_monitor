/*
    YARA Rules for Malware Detection
    Safe static analysis - no execution
*/

// Webshell Detection
rule PHP_Webshell_Generic {
    meta:
        description = "Detects common PHP webshell patterns"
        severity = "HIGH"
        author = "ShadowTrap"
    strings:
        $eval = "eval(" nocase
        $exec = "exec(" nocase
        $system = "system(" nocase
        $passthru = "passthru(" nocase
        $shell_exec = "shell_exec(" nocase
        $base64 = "base64_decode(" nocase
        $cmd = "$_REQUEST[" nocase
        $cmd2 = "$_GET[" nocase
        $cmd3 = "$_POST[" nocase
    condition:
        any of ($eval, $exec, $system, $passthru, $shell_exec) and
        any of ($cmd, $cmd2, $cmd3, $base64)
}

rule PHP_Webshell_C99 {
    meta:
        description = "C99 Webshell"
        severity = "CRITICAL"
    strings:
        $c99 = "c99shell" nocase
        $c99_2 = "c99sh" nocase
        $c99_3 = "web-shell" nocase
    condition:
        any of them
}

rule PHP_Webshell_R57 {
    meta:
        description = "R57 Webshell"
        severity = "CRITICAL"
    strings:
        $r57 = "r57shell" nocase
        $r57_2 = "r57.php" nocase
    condition:
        any of them
}

// Windows PE Malware
rule PE_Suspicious_Packed {
    meta:
        description = "Potentially packed Windows executable"
        severity = "MEDIUM"
    strings:
        $upx = "UPX!" ascii
        $aspack = ".aspack" ascii
        $pecompact = "PECompact" ascii
        $fsg = "FSG!" ascii
    condition:
        uint16(0) == 0x5A4D and any of them
}

rule PE_Suspicious_Imports {
    meta:
        description = "Windows executable with suspicious imports"
        severity = "HIGH"
    strings:
        $virt_alloc = "VirtualAlloc" ascii wide
        $virt_protect = "VirtualProtect" ascii wide
        $write_proc = "WriteProcessMemory" ascii wide
        $create_remote = "CreateRemoteThread" ascii wide
        $nt_unmap = "NtUnmapViewOfSection" ascii wide
    condition:
        uint16(0) == 0x5A4D and 3 of them
}

// Shellcode Detection
rule Shellcode_x86_Generic {
    meta:
        description = "Generic x86 shellcode patterns"
        severity = "CRITICAL"
    strings:
        // Common shellcode sequences
        $nop_sled = { 90 90 90 90 90 90 90 90 }
        $xor_decoder = { 31 ?? 31 ?? 31 ?? }
        $call_pop = { E8 00 00 00 00 5? }
        $winexec = { 57 69 6E 45 78 65 63 }
    condition:
        any of them
}

// Ransomware Indicators
rule Ransomware_Generic {
    meta:
        description = "Generic ransomware patterns"
        severity = "CRITICAL"
    strings:
        $btc = /[13][a-km-zA-HJ-NP-Z1-9]{25,34}/ ascii wide
        $ransom1 = "your files have been encrypted" nocase
        $ransom2 = "pay the ransom" nocase
        $ransom3 = "decrypt your files" nocase
        $ransom4 = "bitcoin" nocase
        $ext1 = ".locked" ascii
        $ext2 = ".encrypted" ascii
        $ext3 = ".crypted" ascii
    condition:
        $btc and 2 of ($ransom*) or
        3 of ($ransom*) or
        2 of ($ext*)
}

// Exploit Kits
rule Exploit_Kit_Generic {
    meta:
        description = "Possible exploit kit patterns"
        severity = "HIGH"
    strings:
        $jndi = "${jndi:" nocase
        $log4j = "log4j" nocase
        $ognl = "ognl" nocase
        $struts = "struts" nocase
    condition:
        $jndi or ($log4j and $ognl)
}

// Office Macro Malware
rule Office_Macro_Suspicious {
    meta:
        description = "Suspicious Office macro patterns"
        severity = "HIGH"
    strings:
        $auto = "AutoOpen" ascii nocase
        $auto2 = "Auto_Open" ascii nocase
        $auto3 = "Workbook_Open" ascii nocase
        $shell = "Shell" ascii nocase
        $wscript = "WScript" ascii nocase
        $powershell = "powershell" ascii nocase
        $cmd = "cmd.exe" ascii nocase
        $download = "URLDownloadToFile" ascii nocase
    condition:
        any of ($auto*) and any of ($shell, $wscript, $powershell, $cmd, $download)
}

// PDF Malware
rule PDF_Suspicious_JavaScript {
    meta:
        description = "PDF with suspicious JavaScript"
        severity = "MEDIUM"
    strings:
        $pdf = "%PDF-"
        $js1 = "/JavaScript" nocase
        $js2 = "/JS" nocase
        $action = "/OpenAction" nocase
        $launch = "/Launch" nocase
    condition:
        $pdf at 0 and any of ($js1, $js2, $action, $launch)
}

// Cryptominer
rule Cryptominer_Generic {
    meta:
        description = "Cryptocurrency miner patterns"
        severity = "MEDIUM"
    strings:
        $stratum = "stratum+" ascii wide
        $xmr = "xmr" nocase
        $monero = "monero" nocase
        $coinhive = "coinhive" nocase
        $pool = "pool" ascii
        $miner = "miner" nocase
    condition:
        $stratum or ($pool and any of ($xmr, $monero, $coinhive, $miner))
}

// Backdoor
rule Backdoor_Generic {
    meta:
        description = "Generic backdoor patterns"
        severity = "CRITICAL"
    strings:
        $bind = "bind_shell" nocase
        $reverse = "reverse_shell" nocase
        $nc = "nc -e" ascii
        $ncat = "ncat -e" ascii
        $bash_i = "bash -i" ascii
        $sh_i = "/bin/sh -i" ascii
        $python_socket = "socket.socket" ascii
        $perl_socket = "IO::Socket" ascii
    condition:
        any of them
}
